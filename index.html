<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Photo-Assistant — перерисовщик фото</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    :root{
      --bg:#f6f3ee; --card:#fff; --ink:#1f2328; --muted:#6b7280; --line:#e5e7eb;
      --accent:#3a5a78; --accent-ink:#fff; --drop-dash:#c9cfd6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"SF Pro",Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg);margin:0}
    .app{max-width:980px;margin:0 auto;padding:24px 20px;position:relative}
    header{margin:0 0 18px}
    h1{margin:0 0 6px;font-size:24px;font-weight:600;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:14px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);border:1px solid var(--line)}

    .drop{border:2px dashed var(--drop-dash);border-radius:14px;padding:22px;text-align:center;cursor:pointer;background:#fff}
    .thumbs{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .thumb{width:84px;height:84px;border-radius:10px;overflow:hidden;position:relative;border:1px solid var(--line);background:#fafafa}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .count{display:inline-flex;align-items:center;gap:6px;background:#eef3f7;border:1px solid var(--line);color:#334155;border-radius:999px;padding:4px 10px;font-size:12px}

    .controls{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    button{background:var(--accent);color:var(--accent-ink);border:none;border-radius:10px;padding:12px 16px;cursor:pointer;font-weight:600;touch-action:manipulation}
    button.small{font-size:12px;padding:6px 10px;background:#3d4956}
    button:disabled{opacity:.6;cursor:not-allowed}

    select,input[type=text],textarea{
      padding:10px;border-radius:10px;border:1px solid var(--line);font:inherit;background:#fff;color:var(--ink)
    }

    .results{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
      gap:12px;
      margin-top:10px;
      width:100%;
    }
    .result-card{background:#fbfbfb;border:1px solid var(--line);border-radius:12px;overflow:hidden;padding:6px;text-align:center}
    .result-card a{display:block;text-decoration:none}
    .result-card img{width:100%;height:auto;display:block;pointer-events:none}

    .top-actions{display:flex;gap:8px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}

    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
      .app{padding:18px 14px}
      .drop{padding:28px}
      button{width:100%}
    }
    @media (max-width:420px){
      h1{font-size:20px}
      .thumb{width:72px;height:72px}
      .results{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Photo-Assistant — преобразователь фото</h1>
      <div class="muted">Загрузите фото — выберите стиль — при необходимости добавьте описание — нажмите «Сгенерировать»</div>
    </header>

    <div class="grid">
      <!-- Левая колонка -->
      <div class="card">
        <div class="row" style="margin-bottom:8px">
          <div class="muted">Загрузите одно или несколько фото (пространство, гости, кухня, детали)</div>
          <div class="top-actions">
            <span id="filesCount" class="count" title="Сколько фото выбрано">0 файлов</span>
            <button id="clearBtn" class="small">Очистить</button>
          </div>
        </div>

        <div class="drop" id="dropzone">
          <div style="font-size:14px">Перетащите файлы сюда или
            <label style="color:var(--accent);cursor:pointer">
              <input id="fileInput" type="file" accept="image/*" multiple style="display:none">выберите
            </label>
          </div>
          <div class="muted">Поддерживается загрузка нескольких фотографий</div>
          <div class="thumbs" id="thumbs"></div>
        </div>

        <div class="controls">
          <label for="userPrompt">Ваш prompt</label>
          <textarea id="userPrompt" rows="2" placeholder="Например: add soft daylight, cinematic mood, fine details"></textarea>
        </div>

        <div class="controls">
          <label>Стиль перерисовки</label>
          <select id="styleSelect">
            <option value="pencil">Скетч — простой карандаш</option>
            <option value="watercolor">Акварель</option>
            <option value="oil">Масло</option>
            <option value="colored_pencils">Цветные карандаши</option>
            <option value="markers">Фломастеры</option>
            <option value="photo_real">Фотореалистичная ретушь</option>
          </select>

          <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center">
            <button id="generateBtn">Сгенерировать</button>
            <button id="downloadZipBtn" class="small">Скачать ZIP</button>
          </div>

          <div class="muted">Обработка выполняется на сервере. В «Результатах» появятся готовые изображения; клик — сразу скачивание PNG.</div>
        </div>
      </div>

      <!-- Правая колонка -->
      <div class="card">
        <div class="row">
          <div><strong>Результаты</strong></div>
          <div class="muted">Клик по изображению — скачать</div>
        </div>

        <div id="progress" class="muted" style="display:none;margin:10px 0"></div>
        <div id="results" class="results"></div>
      </div>
    </div>
  </div>

  <script>
    const DEFAULT_ENDPOINT = 'https://photo-assistant-backend.onrender.com/api/transform';

    function showError(msg){
      console.error(msg);
      const div = document.createElement('div');
      div.style.cssText = 'background:#ffe6e6;border:1px solid #ffb3b3;color:#7a0000;padding:8px 10px;border-radius:8px;margin:8px 0;font-size:14px';
      div.textContent = typeof msg === 'string' ? msg : (msg && msg.message) ? msg.message : String(msg);
      document.querySelector('.app').prepend(div);
      setTimeout(()=>div.remove(), 6000);
    }

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const thumbs = document.getElementById('thumbs');
    const results = document.getElementById('results');
    const progressEl = document.getElementById('progress');
    const styleSelect = document.getElementById('styleSelect');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadZipBtn = document.getElementById('downloadZipBtn');
    const userPrompt = document.getElementById('userPrompt');
    const filesCount = document.getElementById('filesCount');

    let files = [];
    let resultsData = []; // [{name,dataUrlPNG}]

    // --------- Drag & Drop / выбор файлов
    ['dragover','drop'].forEach(evt => window.addEventListener(evt, e=>{ e.preventDefault(); }));
    ;['dragenter','dragover'].forEach(evt=>dropzone.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dropzone.style.borderColor='#8fa6bb'}));
    ;['dragleave','dragend','drop'].forEach(evt=>dropzone.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dropzone.style.borderColor='var(--drop-dash)'}));
    dropzone.addEventListener('drop',e=> {
      try{
        const list = e.dataTransfer && (e.dataTransfer.items || e.dataTransfer.files);
        addFromAny(list);
      }catch(err){ showError('Не удалось обработать перетаскивание: '+ (err.message||err)); }
    });
    fileInput.addEventListener('change',e=> addFromAny(e.target.files));

    clearBtn.onclick=()=>{
      files.forEach(f=>f.url && URL.revokeObjectURL(f.url));
      files=[]; updateFilesCount(); thumbs.innerHTML='';
      resultsData=[]; results.innerHTML='';
      progressEl.style.display='none'; userPrompt.value='';
    };

    generateBtn.onclick=async()=>{
      if(files.length===0){alert('Сначала загрузите фото');return;}
      results.innerHTML=''; resultsData=[];
      progressEl.style.display='block'; progressEl.textContent = 'Отправляю на сервер…';
      try{
        await processOnServer(); // только серверная обработка (одним запросом)
        progressEl.textContent = 'Готово';
      }catch(err){
        showError(err);
      }finally{
        setTimeout(()=>{ progressEl.style.display='none'; }, 1200);
      }
    };

    downloadZipBtn.onclick=async()=>{
      if(resultsData.length===0){alert('Нет результатов');return;}
      try{
        const zip=new JSZip();
        resultsData.forEach((r,i)=>{
          const base64=r.dataUrl.split(',')[1];
          zip.file(`result-${i+1}.png`,base64,{base64:true});
        });
        const blob=await zip.generateAsync({type:'blob'});
        const url = URL.createObjectURL(blob);
        downloadFile(url,'results.zip');
      }catch(err){ showError('ZIP: '+(err.message||err)); }
    };

    function updateFilesCount(){
      const n = files.length;
      filesCount.textContent = n===0 ? '0 файлов' : (n===1 ? '1 файл' : `${n} файлов`);
    }

    function addFromAny(src){
      try{
        let arr = [];
        if(!src) return;
        if(src instanceof FileList) arr = Array.from(src);
        else if(Array.isArray(src)) arr = src;
        else if(src.length && src[0] instanceof File) arr = Array.from(src);
        else if(src.length && src[0] && src[0].getAsFile){
          arr = Array.from(src).map(x=>x.getAsFile()).filter(Boolean);
        }
        if(!arr.length){ showError('Не найдено файлов изображений'); return; }
        const allowed = ['image/jpeg','image/png','image/webp','image/gif','image/bmp','image/avif','image/heic','image/heif'];
        arr.forEach(f=>{
          const isImg = (f.type && f.type.startsWith('image/')) || allowed.includes(f.type) || /\.(jpe?g|png|webp|gif|bmp|avif|heic|heif)$/i.test(f.name||'');
          if(!isImg){ return; }
          const url = URL.createObjectURL(f);
          const rec = {file:f, name:f.name, url};
          files.push(rec);

          // превью только в thumbs
          const d=document.createElement('div'); d.className='thumb';
          const im=new Image(); im.src=url; im.alt=f.name; d.appendChild(im);
          thumbs.appendChild(d);
        });
        updateFilesCount();
      }catch(err){ showError('addFromAny: '+(err.message||err)); }
    }

    function downloadFile(href,filename){
      const a=document.createElement('a');
      a.href=href; a.download=filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Конвертация любого dataURL в PNG dataURL (если уже PNG — вернёт как есть)
    async function ensurePngDataUrl(dataUrl){
      try{
        if(/^data:image\/png;/i.test(dataUrl)) return dataUrl;
        const img = await new Promise((res,rej)=>{
          const im=new Image();
          im.crossOrigin = 'anonymous';
          im.onload=()=>res(im);
          im.onerror=()=>rej(new Error('Не удалось загрузить изображение для конвертации'));
          im.src=dataUrl;
        });
        const canv=document.createElement('canvas');
        canv.width=img.width; canv.height=img.height;
        const ctx=canv.getContext('2d');
        ctx.drawImage(img,0,0);
        return canv.toDataURL('image/png');
      }catch(e){
        console.warn('ensurePngDataUrl fallback:', e);
        return dataUrl;
      }
    }

    // ---- карточка результата (скачивание PNG, плюс "Открыть в новой вкладке")
    async function addResultCard(dataUrl, filenameBase){
      const pngUrl = await ensurePngDataUrl(dataUrl);

      // гарантируем одно расширение .png
      const cleanBase = (filenameBase || 'image').replace(/\.png$/i,'');
      const fileName = cleanBase + '.png';

      const card=document.createElement('div'); card.className='result-card';

      // ссылка "скачать"
      const a=document.createElement('a'); a.href=pngUrl; a.download=fileName;
      const img=document.createElement('img'); img.src=pngUrl; img.alt=cleanBase;
      a.appendChild(img);

      // ссылка "открыть в новой вкладке" — удобно для сохранения в «Фото»
      const openBtn = document.createElement('a');
      openBtn.href = pngUrl;
      openBtn.target = '_blank';
      openBtn.rel = 'noopener';
      openBtn.textContent = 'Открыть';
      openBtn.style.cssText = 'display:inline-block;margin-top:6px;font-size:12px;color:#3a5a78;text-decoration:underline';

      card.appendChild(a);
      card.appendChild(openBtn);
      results.appendChild(card);

      resultsData.push({ name: fileName, dataUrl: pngUrl });
    }

    // ---- Серверная обработка (ОДИН запрос на все фото)
    async function processOnServer(){
      const url = DEFAULT_ENDPOINT;

      const fd = new FormData();
      fd.append('style', styleSelect.value);
      fd.append('prompt', (userPrompt.value || ''));
      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        fd.append('photos', f.file || f, (f.name || `image-${i+1}.jpg`));
      }

      progressEl.textContent = `Отправка ${files.length} фото на сервер…`;
      const resp = await fetch(url, { method:'POST', body: fd });
      if(!resp.ok){ throw new Error('Сервер вернул статус '+resp.status); }
      const data = await resp.json();
      if(!data || !Array.isArray(data.images) || !data.images.length){
        throw new Error('Неожиданный ответ сервера');
      }

      // рендерим только сгенерированные результаты
      for (let idx = 0; idx < data.images.length; idx++) {
        const imgObj = data.images[idx];
        if(!imgObj || !imgObj.dataUrl) continue;
        const original = files[idx]?.name || `image-${idx+1}`;
        const base = original.replace(/\.(png|jpe?g|webp|gif|bmp|avif|heic|heif)$/i,'') + '-out';
        await addResultCard(imgObj.dataUrl, base);
      }
    }
  </script>
</body>
</html>
