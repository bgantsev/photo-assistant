<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Photo-Assistant — перерисовщик фото</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    :root{
      --bg:#f6f3ee; --card:#fff; --ink:#1f2328; --muted:#6b7280; --line:#e5e7eb;
      --accent:#3a5a78; --accent-ink:#fff; --drop-dash:#c9cfd6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"SF Pro",Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg);margin:0}
    img{image-orientation: from-image;} /* учитываем EXIF-ориентацию при рендере */

    .app{max-width:980px;margin:0 auto;padding:24px 20px;position:relative}
    header{margin:0 0 18px}
    h1{margin:0 0 6px;font-size:24px;font-weight:600;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:14px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);border:1px solid var(--line)}

    .drop{border:2px dashed var(--drop-dash);border-radius:14px;padding:22px;text-align:center;cursor:pointer;background:#fff}
    .thumbs{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .thumb{width:96px;height:96px;border-radius:10px;overflow:hidden;position:relative;border:1px solid var(--line);background:#fafafa}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .count{display:inline-flex;align-items:center;gap:6px;background:#eef3f7;border:1px solid var(--line);color:#334155;border-radius:999px;padding:4px 10px;font-size:12px}

    .controls{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    button{background:var(--accent);color:var(--accent-ink);border:none;border-radius:10px;padding:12px 16px;cursor:pointer;font-weight:600;touch-action:manipulation}
    button.small{font-size:12px;padding:6px 10px;background:#3d4956}
    button:disabled{opacity:.6;cursor:not-allowed}

    select,textarea{
      padding:10px;border-radius:10px;border:1px solid var(--line);font:inherit;background:#fff;color:var(--ink)
    }

    .results{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:12px;
      margin-top:10px;
      width:100%;
    }
    .result-card{background:#fbfbfb;border:1px solid var(--line);border-radius:12px;overflow:hidden;padding:6px;text-align:center}
    .result-card .open{display:block;text-decoration:none;cursor:pointer}
    .result-card img{width:100%;height:auto;display:block}

    .top-actions{display:flex;gap:8px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}

    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
      .app{padding:18px 14px}
      .drop{padding:28px}
      button{width:100%}
    }
    @media (max-width:420px){
      h1{font-size:20px}
      .thumb{width:80px;height:80px}
      .results{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Photo-Assistant — преобразователь фото</h1>
      <div class="muted">Загрузите фото — выберите стиль — при желании добавьте описание — нажмите «Сгенерировать»</div>
    </header>

    <div class="grid">
      <!-- Левая колонка -->
      <div class="card">
        <div class="row" style="margin-bottom:8px">
          <div class="muted">Загрузите одно или несколько фото (пространство, гости, кухня, детали)</div>
          <div class="top-actions">
            <span id="filesCount" class="count" title="Сколько фото выбрано">0 файлов</span>
            <button id="clearBtn" class="small">Очистить</button>
          </div>
        </div>

        <div class="drop" id="dropzone">
          <div style="font-size:14px">Перетащите файлы сюда или
            <label style="color:var(--accent);cursor:pointer">
              <input id="fileInput" type="file" accept="image/*" multiple style="display:none">выберите
            </label>
          </div>
          <div class="muted">Поддерживается загрузка нескольких фотографий</div>
          <div class="thumbs" id="thumbs"></div>
        </div>

        <div class="controls">
          <label for="userPrompt">Ваш prompt</label>
          <textarea id="userPrompt" rows="2" placeholder="Например: add soft daylight, cinematic mood, fine details"></textarea>
        </div>

        <div class="controls">
          <label>Стиль перерисовки</label>
          <select id="styleSelect">
            <option value="pencil">Скетч — простой карандаш</option>
            <option value="watercolor">Акварель</option>
            <option value="oil">Масло</option>
            <option value="colored_pencils">Цветные карандаши</option>
            <option value="markers">Фломастеры</option>
            <option value="photo_real">Фотореалистичная ретушь</option>
          </select>

          <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center">
            <button id="generateBtn">Сгенерировать</button>
            <button id="downloadZipBtn" class="small">Скачать ZIP</button>
          </div>

          <div class="muted">Обработка выполняется на сервере. В «Результатах» появятся готовые изображения; клик откроет их в новой вкладке.</div>
        </div>
      </div>

      <!-- Правая колонка -->
      <div class="card">
        <div class="row">
          <div><strong>Результаты</strong></div>
          <div class="top-actions">
            <button id="openAllBtn" class="small" title="Открыть все результаты в новых вкладках">Открыть все</button>
            <button id="clearSavedBtn" class="small" title="Удалить сохранённые в памяти результаты">Очистить сохранённые</button>
          </div>
        </div>

        <div id="progress" class="muted" style="display:none;margin:10px 0"></div>
        <div id="results" class="results"></div>
      </div>
    </div>
  </div>

  <script>
    const DEFAULT_ENDPOINT = 'https://photo-assistant-backend.onrender.com/api/transform';

    function showError(msg){
      console.error(msg);
      const div = document.createElement('div');
      div.style.cssText = 'background:#ffe6e6;border:1px solid #ffb3b3;color:#7a0000;padding:8px 10px;border-radius:8px;margin:8px 0;font-size:14px';
      div.textContent = typeof msg === 'string' ? msg : (msg && msg.message) ? msg.message : String(msg);
      document.querySelector('.app').prepend(div);
      setTimeout(()=>div.remove(), 6000);
    }

    // ---------- DOM
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const thumbs = document.getElementById('thumbs');
    const results = document.getElementById('results');
    const progressEl = document.getElementById('progress');
    const styleSelect = document.getElementById('styleSelect');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadZipBtn = document.getElementById('downloadZipBtn');
    const clearSavedBtn = document.getElementById('clearSavedBtn');
    const openAllBtn = document.getElementById('openAllBtn');
    const userPrompt = document.getElementById('userPrompt');
    const filesCount = document.getElementById('filesCount');

    let files = [];        // [{file, name, url}] — уже ориентированные, если получилось
    let resultsData = [];  // { name, blobUrl }
    let pendingAdds = 0;   // сколько файлов ещё «готовится»

    // ---------- IndexedDB
    const DB_NAME = 'photoAssistant';
    const DB_VERSION = 1;
    const STORE = 'results';

    function openDB(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE)) {
            db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
          }
        };
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function saveResultToDB(name, blob){
      const db = await openDB();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE, 'readwrite');
        tx.oncomplete = ()=>resolve();
        tx.onerror = ()=>reject(tx.error);
        tx.objectStore(STORE).add({ name, blob, ts: Date.now() });
      });
    }

    async function getAllResultsFromDB(){
      const db = await openDB();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE, 'readonly');
        const req = tx.objectStore(STORE).getAll();
        req.onsuccess = ()=>resolve(req.result || []);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function clearResultsDB(){
      const db = await openDB();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE, 'readwrite');
        tx.oncomplete = ()=>resolve();
        tx.onerror = ()=>reject(tx.error);
        tx.objectStore(STORE).clear();
      });
    }

    // восстановление сохранённых
    window.addEventListener('DOMContentLoaded', async ()=>{
      try{
        const saved = await getAllResultsFromDB();
        if (saved.length){
          for (const rec of saved){
            const url = URL.createObjectURL(rec.blob);
            addResultCardFromBlobUrl(url, rec.name);
          }
          progressEl.style.display='block';
          progressEl.textContent = `Восстановлено сохранённых изображений: ${saved.length}`;
          setTimeout(()=>progressEl.style.display='none', 1800);
        }
      }catch(e){
        console.warn('restore failed', e);
      }
    });

    // --------- DnD / выбор
    ['dragover','drop'].forEach(evt => window.addEventListener(evt, e=>{ e.preventDefault(); }));
    ;['dragenter','dragover'].forEach(evt=>dropzone.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dropzone.style.borderColor='#8fa6bb'}));
    ;['dragleave','dragend','drop'].forEach(evt=>dropzone.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dropzone.style.borderColor='var(--drop-dash)'}));
    dropzone.addEventListener('drop',async e=> {
      try{
        const list = e.dataTransfer && (e.dataTransfer.items || e.dataTransfer.files);
        await addFromAny(list); // ждём, пока всё добавится
      }catch(err){ showError('Не удалось обработать перетаскивание: '+ (err.message||err)); }
    });
    fileInput.addEventListener('change',async e=> { await addFromAny(e.target.files); });

    clearBtn.onclick=()=>{
      files.forEach(f=>f.url && URL.revokeObjectURL(f.url));
      files=[]; updateFilesCount(); thumbs.innerHTML='';
      progressEl.style.display='none'; userPrompt.value='';
      // сохранённые результаты не трогаем
    };

    clearSavedBtn.onclick=async()=>{
      try{
        await clearResultsDB();
        resultsData=[]; results.innerHTML='';
        progressEl.style.display='block';
        progressEl.textContent = 'Сохранённые изображения удалены';
        setTimeout(()=>progressEl.style.display='none', 1400);
      }catch(e){ showError('Не удалось очистить сохранённые: '+(e.message||e)); }
    };

    openAllBtn.onclick=()=>{
      if (!resultsData.length){ showError('Нет результатов для открытия'); return; }
      let i = 0;
      const openNext = ()=>{
        if (i >= resultsData.length) return;
        const url = resultsData[i].blobUrl;
        try{ window.open(url, '_blank', 'noopener'); }catch(e){}
        i++;
        setTimeout(openNext, 150);
      };
      openNext();
    };

    generateBtn.onclick=async()=>{
      if(files.length===0){alert('Сначала загрузите фото');return;}

      // ждём окончания подготовки всех файлов
      if (pendingAdds > 0){
        progressEl.style.display='block'; progressEl.textContent = 'Подготовка файлов…';
        while (pendingAdds > 0) { await new Promise(r=>setTimeout(r,120)); }
      }

      results.innerHTML=''; resultsData=[];
      progressEl.style.display='block'; progressEl.textContent = 'Отправляю на сервер…';
      try{
        await processOnServer(); // один запрос на все фото
        progressEl.textContent = 'Готово';
      }catch(err){
        showError(err);
      }finally{
        setTimeout(()=>{ progressEl.style.display='none'; }, 1200);
      }
    };

    downloadZipBtn.onclick=async()=>{
      if(resultsData.length===0){alert('Нет результатов');return;}
      try{
        const zip=new JSZip();
        for (let i=0;i<resultsData.length;i++){
          const rec = resultsData[i];
          const b = await (await fetch(rec.blobUrl)).blob();
          zip.file(rec.name, b);
        }
        const blob=await zip.generateAsync({type:'blob'});
        const url = URL.createObjectURL(blob);
        triggerDownload(url,'results.zip');
      }catch(err){ showError('ZIP: '+(err.message||err)); }
    };

    function updateFilesCount(){
      const n = files.length;
      filesCount.textContent = n===0 ? '0 файлов' : (n===1 ? '1 файл' : `${n} файлов`);
    }

    // ---------- ОРИЕНТАЦИЯ: нормализуем файл (если возможно)
    async function normalizeOrientationFile(file){
      try{
        const bmp = await createImageBitmap(file, { imageOrientation: 'from-image' });
        const canv = document.createElement('canvas');
        canv.width = bmp.width;
        canv.height = bmp.height;
        const ctx = canv.getContext('2d');
        ctx.drawImage(bmp, 0, 0);

        // JPEG -> JPEG, остальное -> PNG
        let outType = 'image/png';
        if (/jpe?g$/i.test(file.name) || /image\/jpe?g/i.test(file.type)) {
          outType = 'image/jpeg';
        }

        const blob = await new Promise(res=>canv.toBlob(res, outType, 0.95));
        if (!blob) return file;

        const ext = outType === 'image/jpeg' ? '.jpg' : '.png';
        const base = (file.name || 'image').replace(/\.(heic|heif|png|jpe?g|webp|gif|bmp|avif)$/i,'');
        const orientedName = base + ext;

        return new File([blob], orientedName, { type: outType, lastModified: Date.now() });
      }catch(e){
        return file; // fallback
      }
    }

    // ДОБАВЛЕНИЕ ФАЙЛОВ (с ожиданием завершения)
    async function addFromAny(src){
      try{
        let arr = [];
        if(!src) return;
        if(src instanceof FileList) arr = Array.from(src);
        else if(Array.isArray(src)) arr = src;
        else if(src.length && src[0] instanceof File) arr = Array.from(src);
        else if(src.length && src[0] && src[0].getAsFile){
          arr = Array.from(src).map(x=>x.getAsFile()).filter(Boolean);
        }
        if(!arr.length){ showError('Не найдено файлов изображений'); return; }

        const allowed = ['image/jpeg','image/png','image/webp','image/gif','image/bmp','image/avif','image/heic','image/heif'];

        pendingAdds += arr.length;
        generateBtn.disabled = true;

        for (const f of arr){
          const isImg = (f.type && f.type.startsWith('image/')) || allowed.includes(f.type) || /\.(jpe?g|png|webp|gif|bmp|avif|heic|heif)$/i.test(f.name||'');
          if(!isImg){ pendingAdds--; continue; }

          const oriented = await normalizeOrientationFile(f);
          const url = URL.createObjectURL(oriented);
          const rec = {file: oriented, name: oriented.name, url};
          files.push(rec);

          const d=document.createElement('div'); d.className='thumb';
          const im=new Image(); im.src=url; im.alt=oriented.name; d.appendChild(im);
          thumbs.appendChild(d);

          pendingAdds--;
        }

        if (pendingAdds <= 0){
          generateBtn.disabled = false;
        }
        updateFilesCount();
      }catch(err){
        pendingAdds = 0;
        generateBtn.disabled = false;
        showError('addFromAny: '+(err.message||err));
      }
    }

    function triggerDownload(href,filename){
      const a=document.createElement('a');
      a.href=href; a.download=filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function dataUrlToPngBlob(dataUrl){
      const res = await fetch(dataUrl);
      const blob = await res.blob();
      if (blob.type === 'image/png') return blob;

      const img = await new Promise((res,rej)=>{
        const im=new Image();
        im.crossOrigin = 'anonymous';
        im.onload=()=>res(im);
        im.onerror=()=>rej(new Error('Не удалось загрузить изображение'));
        im.src=dataUrl;
      });
      const canv=document.createElement('canvas');
      canv.width=img.width; canv.height=img.height;
      const ctx=canv.getContext('2d');
      ctx.drawImage(img,0,0);
      return await new Promise(r=>canv.toBlob(r,'image/png'));
    }

    // ——— карточка результата: ПРОГРАММНОЕ открытие по клику (чтобы не скачивало на десктопах)
    function addResultCardFromBlobUrl(blobUrl, filename){
      const cleanBase = (filename || 'image').replace(/\.png$/i,'');

      const img=document.createElement('img');
      img.src = blobUrl;
      img.alt = cleanBase;

      const openLink = document.createElement('a');
      openLink.href = '#';
      openLink.className = 'open';
      openLink.appendChild(img);
      openLink.addEventListener('click', (e)=>{
        e.preventDefault();
        try{ window.open(blobUrl, '_blank', 'noopener'); }catch(_){}
      });

      const card=document.createElement('div'); card.className='result-card';
      card.appendChild(openLink);
      results.appendChild(card);

      resultsData.push({ name: cleanBase+'.png', blobUrl });
    }

    async function addResultCardFromDataUrl(dataUrl, filenameBase){
      const cleanBase = (filenameBase || 'image').replace(/\.png$/i,'');
      const pngBlob = await dataUrlToPngBlob(dataUrl);
      const blobUrl = URL.createObjectURL(pngBlob);
      addResultCardFromBlobUrl(blobUrl, cleanBase+'.png');
      try{ await saveResultToDB(cleanBase+'.png', pngBlob); }catch(e){ console.warn('save to DB failed', e); }
    }

    // ---- один запрос на все фото
    async function processOnServer(){
      const url = DEFAULT_ENDPOINT;

      const fd = new FormData();
      fd.append('style', styleSelect.value);
      fd.append('prompt', (userPrompt.value || ''));
      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        fd.append('photos', f.file || f, (f.name || `image-${i+1}.jpg`));
      }

      progressEl.textContent = `Отправка ${files.length} фото на сервер…`;
      const resp = await fetch(url, { method:'POST', body: fd });
      if(!resp.ok){ throw new Error('Сервер вернул статус '+resp.status); }
      const data = await resp.json();
      if(!data || !Array.isArray(data.images) || !data.images.length){
        throw new Error('Неожиданный ответ сервера');
      }

      for (let idx = 0; idx < data.images.length; idx++) {
        const imgObj = data.images[idx];
        if(!imgObj || !imgObj.dataUrl) continue;
        const original = files[idx]?.name || `image-${idx+1}`;
        const base = original.replace(/\.(png|jpe?g|webp|gif|bmp|avif|heic|heif)$/i,'') + '-out';
        await addResultCardFromDataUrl(imgObj.dataUrl, base);
      }
    }
  </script>
</body>
</html>
