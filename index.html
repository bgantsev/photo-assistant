<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Photo-Assistant — перерисовщик фото</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    :root{
      --bg: #f6f3ee;
      --card: #ffffff;
      --ink: #1f2328;
      --muted: #6b7280;
      --line: #e5e7eb;
      --accent: #3a5a78;
      --accent-ink: #ffffff;
      --drop-dash: #c9cfd6;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body {font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro", Roboto, Arial, sans-serif; color:var(--ink); background:var(--bg); margin:0}

    .app {max-width: 980px; margin:0 auto; padding:24px 20px; position:relative}
    header {margin:0 0 18px}
    h1 {margin:0 0 6px; font-size:24px; font-weight:600; letter-spacing:.2px}
    .muted {color:var(--muted); font-size:14px}

    .grid {display:grid; grid-template-columns:1fr 1fr; gap:20px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card {background:var(--card); border-radius:14px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,0.06); border:1px solid var(--line)} 

    .drop {border:2px dashed var(--drop-dash); border-radius:14px; padding:22px; text-align:center; cursor:pointer; background:#fff}
    .thumbs {display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .thumb {width:84px; height:84px; border-radius:10px; overflow:hidden; position:relative; border:1px solid var(--line); background:#fafafa}
    .thumb img {width:100%; height:100%; object-fit:cover}

    .controls {margin-top:14px; display:flex; flex-direction:column; gap:10px}
    button {background:var(--accent); color:var(--accent-ink); border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600}
    button.small {font-size:12px; padding:5px 9px; background:#3d4956}
    button:disabled{opacity:.6; cursor:not-allowed}

    select, input[type=range], input[type=text], textarea {
      padding:8px; border-radius:10px; border:1px solid var(--line); font:inherit; background:#fff; color:var(--ink)
    }

    .results {display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; margin-top:10px}
    .result-card {background:#fbfbfb; border:1px solid var(--line); border-radius:12px; overflow:hidden; padding:6px; text-align:center}
    .result-card img {width:100%; cursor:pointer}

    .top-actions {display:flex; gap:8px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Photo-Assistant — преобразователь фото</h1>
      <div class="muted">Загрузите фото — выберите стиль — при необходимости добавьте описание желаемого результата самостоятельно — нажмите «Сгенерировать»</div>
    </header>

    <div class="grid">
      <!-- Левая колонка: загрузка и настройки -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="muted">Загрузите одно или несколько фотографий (пространство, гости, кухня, детали)</div>
          <div class="top-actions">
            <button id="clearBtn" class="small">Очистить</button>
          </div>
        </div>

        <div class="drop" id="dropzone">
          <div style="font-size:14px">Перетащите файлы сюда или <label style="color:var(--accent);cursor:pointer"><input id="fileInput" type="file" accept="image/*" multiple style="display:none">выберите</label></div>
          <div class="muted">Поддерживается загрузка нескольких фотографий</div>
          <div class="thumbs" id="thumbs"></div>
        </div>

        <!-- Поле: Ваш prompt -->
        <div class="controls">
          <label for="userPrompt">Ваш prompt</label>
          <textarea id="userPrompt" rows="2" placeholder="Например: add soft daylight, cinematic mood, fine details"></textarea>
        </div>

        <div class="controls">
          <label>Стиль перерисовки</label>
          <select id="styleSelect">
            <option value="pencil">Скетч — простой карандаш</option>
            <option value="watercolor">Акварель</option>
            <option value="oil">Масло</option>
            <option value="colored_pencils">Цветные карандаши</option>
            <option value="markers">Фломастеры</option>
            <option value="photo_real">Фотореалистичная ретушь</option>
          </select>

          <label>Интенсивность эффекта <span id="intVal" class="muted">0.7</span></label>
          <input id="intensity" type="range" min="0" max="1" step="0.05" value="0.7">

          <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center">
            <button id="generateBtn">Сгенерировать</button>
            <button id="downloadZipBtn" class="small">Скачать ZIP</button>
            <label style="display:flex;align-items:center;gap:6px;margin-left:auto">
              <input id="useServer" type="checkbox"> Обрабатывать на сервере
            </label>
            <input id="serverUrl" type="text" placeholder="http://localhost:3001/api/transform" style="flex:1;min-width:260px;padding:8px;border-radius:10px;border:1px solid var(--line)"/>
          </div>

          <div class="muted">Если включено «Обрабатывать на сервере», изображения отправляются на указанный endpoint как <code>multipart/form-data</code> (поле <code>photos</code>) + <code>style</code>, <code>intensity</code>, <code>prompt</code>.</div>
        </div>
      </div>

      <!-- Правая колонка: результаты -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Результаты</strong></div>
          <div class="muted">Клик по изображению — скачать</div>
        </div>

        <div id="progress" class="muted" style="display:none;margin-bottom:8px"></div>
        <div id="results" class="results"></div>
      </div>
    </div>
  </div>

  <script>
    // --- уведомления об ошибке ---
    function showError(msg){
      console.error(msg);
      const div = document.createElement('div');
      div.style.cssText = 'background:#ffe6e6;border:1px solid #ffb3b3;color:#7a0000;padding:8px 10px;border-radius:8px;margin:8px 0;font-size:14px';
      div.textContent = typeof msg === 'string' ? msg : (msg && msg.message) ? msg.message : String(msg);
      document.querySelector('.app').prepend(div);
      setTimeout(()=>div.remove(), 6000);
    }

    // --- DOM ссылки ---
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const thumbs = document.getElementById('thumbs');
    const results = document.getElementById('results');
    const progressEl = document.getElementById('progress');
    const styleSelect = document.getElementById('styleSelect');
    const intensity = document.getElementById('intensity');
    const intVal = document.getElementById('intVal');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadZipBtn = document.getElementById('downloadZipBtn');
    const useServer = document.getElementById('useServer');
    const serverUrl = document.getElementById('serverUrl');
    const userPrompt = document.getElementById('userPrompt');

    let files = [];
    let resultsData = [];

    // --- блокируем дефолтное поведение браузера для dnd ---
    ['dragover','drop'].forEach(evt => window.addEventListener(evt, e=>{ e.preventDefault(); }));

    // --- DnD на зоне ---
    ;['dragenter','dragover'].forEach(evt=>dropzone.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dropzone.style.borderColor='#8fa6bb'}));
    ;['dragleave','dragend','drop'].forEach(evt=>dropzone.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dropzone.style.borderColor='var(--drop-dash)'}));
    dropzone.addEventListener('drop',e=> {
      try{
        const list = e.dataTransfer && (e.dataTransfer.items || e.dataTransfer.files);
        addFromAny(list);
      }catch(err){ showError('Не удалось обработать перетаскивание: '+ (err.message||err)); }
    });

    // --- input файлов ---
    fileInput.addEventListener('change',e=> addFromAny(e.target.files));

    // --- кнопки ---
    clearBtn.onclick=()=>{
      files.forEach(f=>f.url && URL.revokeObjectURL(f.url));
      files=[]; resultsData=[]; thumbs.innerHTML=''; results.innerHTML='';
      progressEl.style.display='none'; userPrompt.value='';
    };
    intensity.oninput=()=>intVal.textContent=intensity.value;

    generateBtn.onclick=async()=>{
      if(files.length===0){alert('Сначала загрузите фото');return;}
      const doServer = useServer.checked && serverUrl.value.trim();
      results.innerHTML='';resultsData=[];
      progressEl.style.display='block';
      progressEl.textContent = 'Готовлюсь…';
      try{
        if(doServer){ await processOnServer(); } else { await processLocally(); }
        progressEl.textContent = 'Готово';
      }catch(err){
        showError(err);
      }finally{
        setTimeout(()=>{ progressEl.style.display='none'; }, 1200);
      }
    };

    downloadZipBtn.onclick=async()=>{
      if(resultsData.length===0){alert('Нет результатов');return;}
      try{
        const zip=new JSZip();
        resultsData.forEach((r,i)=>{
          const base64=r.dataUrl.split(',')[1];
          zip.file(`result-${i+1}.png`,base64,{base64:true});
        });
        const blob=await zip.generateAsync({type:'blob'});
        downloadDataUrl(URL.createObjectURL(blob),'results.zip');
      }catch(err){ showError('ZIP: '+(err.message||err)); }
    };

    // --- добавление файлов в список и предпросмотр ---
    function addFromAny(src){
      try{
        let arr = [];
        if(!src) return;
        if(src instanceof FileList) arr = Array.from(src);
        else if(Array.isArray(src)) arr = src;
        else if(src.length && src[0] instanceof File) arr = Array.from(src);
        else if(src.length && src[0] && src[0].getAsFile){
          arr = Array.from(src).map(x=>x.getAsFile()).filter(Boolean);
        }
        if(!arr.length){ showError('Не найдено файлов изображений'); return; }
        const allowed = ['image/jpeg','image/png','image/webp','image/gif','image/bmp','image/avif'];
        arr.forEach(f=>{
          const isImg = (f.type && f.type.startsWith('image/')) || allowed.some(t=>t===f.type) || /\.(jpe?g|png|webp|gif|bmp|avif)$/i.test(f.name||'');
          if(!isImg){ return; }
          const url = URL.createObjectURL(f);
          const rec = {file:f, name:f.name, url};
          files.push(rec);
          const d=document.createElement('div');d.className='thumb';
          const im=new Image(); im.src=url; im.alt=f.name; d.appendChild(im);
          thumbs.appendChild(d);
          const resCard=document.createElement('div');resCard.className='result-card';
          const imgEl=new Image(); imgEl.src=url; imgEl.alt=f.name; resCard.appendChild(imgEl);
          results.appendChild(resCard);
        });
      }catch(err){ showError('addFromAny: '+(err.message||err)); }
    }

    // --- загрузка HTMLImageElement из File ---
    function loadImageFromFile(file){
      return new Promise((res,rej)=>{
        try{
          const reader = new FileReader();
          reader.onerror = ()=> rej(new Error('Не удалось прочитать файл: '+(file && file.name ? file.name: '')));
          reader.onload = ()=>{
            try{
              const img = new Image();
              img.onload = ()=> res(img);
              img.onerror = ()=> rej(new Error('Изображение повреждено или неподдерживаемый формат: '+(file && file.name ? file.name: '')));
              img.src = reader.result; // data URL
            }catch(e){ rej(e); }
          };
          reader.readAsDataURL(file);
        }catch(err){ rej(err); }
      });
    }

    function downloadDataUrl(url,filename){
      const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();
    }

    // --- простые локальные эффекты (эмуляция стилей) ---
    async function applyStyleEffect(canvas,style,str){
      const ctx=canvas.getContext('2d');
      const id=ctx.getImageData(0,0,canvas.width,canvas.height);
      const d=id.data; const clamp=(v)=>Math.max(0,Math.min(255,v));
      if(style==='pencil'){
        for(let i=0;i<d.length;i+=4){ const g=(d[i]+d[i+1]+d[i+2])/3; const shade = g*(1-str); d[i]=d[i+1]=d[i+2]=shade; }
      } else if(style==='watercolor'){
        for(let i=0;i<d.length;i+=4){ d[i]=d[i]-(d[i]%32); d[i+1]=d[i+1]-(d[i+1]%32); d[i+2]=d[i+2]-(d[i+2]%32);} 
      } else if(style==='oil'){
        for(let i=0;i<d.length;i+=4){ d[i]=clamp(d[i]*(1-str)+128*str); d[i+1]=clamp(d[i+1]*(1-str)+128*str); d[i+2]=clamp(d[i+2]*(1-str)+128*str);} 
      } else if(style==='colored_pencils'){
        for(let i=0;i<d.length;i+=4){ const avg=(d[i]+d[i+1]+d[i+2])/3; d[i]=clamp(avg*(1-str)+d[i]*str); d[i+1]=clamp(avg*(1-str)+d[i+1]*str); d[i+2]=clamp(avg*(1-str)+d[i+2]*str);} 
      } else if(style==='markers'){
        for(let i=0;i<d.length;i+=4){ d[i]=Math.round(d[i]/64)*64; d[i+1]=Math.round(d[i+1]/64)*64; d[i+2]=Math.round(d[i+2]/64)*64; }
      } else if(style==='photo_real'){
        for(let i=0;i<d.length;i+=4){ d[i]=clamp(d[i]*1.1); d[i+1]=clamp(d[i+1]*1.1); d[i+2]=clamp(d[i+2]*1.1);} 
      }
      ctx.putImageData(id,0,0);
    }

    // --- локальная обработка (без сервера) ---
    async function processLocally(){
      for(let i=0;i<files.length;i++){
        progressEl.textContent = `Локальная обработка ${i+1}/${files.length}…`;
        const f = files[i];
        try{
          const img=await loadImageFromFile(f.file || f);
          const canv=document.createElement('canvas');
          canv.width=img.width;canv.height=img.height;
          const ctx=canv.getContext('2d');
          ctx.drawImage(img,0,0);
          await applyStyleEffect(canv,styleSelect.value,parseFloat(intensity.value));
          const dataUrl=canv.toDataURL('image/png');
          resultsData.push({name:(f.name||f.file?.name||'image') , dataUrl});
          const d=document.createElement('div');d.className='result-card';
          const imgel=document.createElement('img');imgel.src=dataUrl; d.appendChild(imgel);
          results.appendChild(d);
        }catch(err){ showError('Ошибка обработки '+(f.name||'файла')+': '+(err.message||err)); }
      }
    }

    // --- серверная обработка (nano-banana endpoint) ---
    async function processOnServer(){
      const url = serverUrl.value.trim();
      for(let i=0;i<files.length;i++){
        progressEl.textContent = `Отправка ${i+1}/${files.length} на сервер…`;
        const f = files[i];
        try{
          const fd = new FormData();
          fd.append('style', styleSelect.value);
          fd.append('intensity', intensity.value); // для совместимости
          fd.append('prompt', (userPrompt.value || ''));
          fd.append('photos', f.file || f, (f.name || 'image'));

          const resp = await fetch(url, { method:'POST', body: fd });
          if(!resp.ok){ throw new Error('Сервер вернул статус '+resp.status); }
          const data = await resp.json();
          if(!data || !Array.isArray(data.images) || !data.images.length){ throw new Error('Неожиданный ответ сервера'); }
          data.images.forEach((imgObj, idx)=>{
            if(!imgObj || !imgObj.dataUrl){ return; }
            resultsData.push({name: imgObj.filename || `${f.name||'image'}-out${idx+1}.png`, dataUrl: imgObj.dataUrl});
            const d=document.createElement('div'); d.className='result-card';
            const imgel=document.createElement('img'); imgel.src=imgObj.dataUrl; d.appendChild(imgel);
            results.appendChild(d);
          });
        }catch(err){ showError('Серверная обработка '+(f.name||'файла')+': '+(err.message||err)); }
      }
    }
  </script>
</body>
</html>
